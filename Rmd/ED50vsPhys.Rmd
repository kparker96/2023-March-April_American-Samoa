---
title: "ED50vsPhys"
output: html_document
date: "2025-12-04"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

# Load data
```{r}
EDs <- read_xlsx("data/PAM/ED_df_master.xlsx")

sample_data <- read_xlsx("data/frag_data/2023-AS_NMS_Mgris_collections.xlsx")

ITS2 <- read_xlsx("data/ITS2/ITS2_type_relabund.xlsx")

pigment <- read_xlsx("data/frag_data/pigment_per_cm2.xlsx")
```

# Make master dataframe 
```{r}
metadata <- sample_data %>%
  select(Geno = Genotype, depth = Depth_Group, colony_depth = Colony_Depth_m, Sample_ID) %>%
  filter(!grepl("Deep_Extra", Sample_ID)) %>%
  filter(depth != "Midd") %>%
  select(depth_Geno = Sample_ID, colony_depth)

ITS2_abun <- ITS2 %>%
  select(sample_name, 
         C15_C15vd_C15ev_C15ww = `C15-C15vd-C15ev-C15ww`, 
         C3, 
         C3_C115d_C1 = `C3-C115d-C1`, 
         C15_C15vd_C15ev = `C15-C15vd-C15ev`, 
         D4_D1ab_D1_D6_D1ns_D1nt = `D4/D1ab-D1-D6-D1ns-D1nt`) %>%
  mutate(depth_Geno = substring(sample_name, first = 13))

pigment_df <- pigment %>%
  pivot_wider(names_from = Pigment, values_from = ug_cm2_pigment) %>%
  select(depth_Geno = Sample, Chl_a_per_cm2:Perid_per_cm2)
  

master_df <- EDs %>%
  left_join(metadata, by = "depth_Geno") %>%
  left_join(ITS2_abun, by = "depth_Geno") %>%
  left_join(pigment_df, by = "depth_Geno")
```

# Cross comparing things
```{r}
# Dom Syms 
dom_syms <- master_df %>% 
  select(depth_Geno, depth, ED50, colony_depth, C15_C15vd_C15ev_C15ww,
         D4_D1ab_D1_D6_D1ns_D1nt) %>%
  gather(key = "SymType", value = Abundance, -depth_Geno, -depth,
         -ED50, -colony_depth)

# Sym abundance
ggplot(dom_syms, aes(x = Abundance, y = ED50, color = SymType)) +
  geom_point() +
  theme(legend.position = "bottom") +
  ggtitle("Sym Abundance vs ED50")

# Chlorophyll C
ggplot(master_df, aes(x = Chl_c_per_cm2, y = ED50, color = depth)) +
  geom_point() +
  ggtitle("Chlorophyll C vs ED50")

# Colony Depth
ggplot(master_df, aes(x = colony_depth, y = C15_C15vd_C15ev_C15ww)) +
  geom_point() +
  ggtitle("C dom-sym abundance vs Depth")

ggplot(master_df, aes(x =  C15_C15vd_C15ev_C15ww, y = ED50, color = depth)) +
  geom_point() +
  ggtitle("C dom-sym abundance vs Depth")

ggplot(master_df, aes(x = D4_D1ab_D1_D6_D1ns_D1nt, y = ED50, color = depth)) +
  geom_point() +
  ggtitle("D dom-sym abundance vs ED50")
```

```{r PCA attempt}
pca_df <- master_df %>%
  filter(depth_Geno != "Shall_05") %>% # has no pigment Data
  select(Chl_a_per_cm2, Chl_c_per_cm2, Perid_per_cm2)

pca_res <- prcomp(pca_df, scale. = TRUE, center = TRUE)

summary(pca_res)

loadings <- pca_res$rotation
scores   <- as.data.frame(pca_res$x)

scores <- bind_cols(
  master_df %>% 
    filter(depth_Geno != "Shall_05")%>%
    select(Geno, depth),scores)

ggplot(scores, aes(PC1, PC2, color = depth)) +
  geom_point(size = 4) +
  theme_minimal()

round(pca_res$rotation[,1:3], 3)
```

